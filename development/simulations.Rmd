---
title: "Signature Sample Size Simulations"
author: "Kiegan Rice"
output: html_document
---

```{r}
library(tidyverse)
library(bulletxtrctr)
library(x3ptools)
library(lme4)
```

```{r}
n_bullets = 3
n_operators = 5
n_machines = 2
n_reps = 3

sigma_bullet = 0.05
sigma_operator = 0.02
sigma_machine = 0.02
sigma_bullet_operator = 0.001
sigma_bullet_machine = 0.001
sigma_operator_machine = 0.001
sigma_operator_bullet_machine = 0.0001
sigma_error = 0.6
location_df <- readRDS("data/simulation_mus_orange_l1.rda")


simulate_sigma_estimates <- function(n_bullets, n_operators, n_machines, n_reps, 
                                     sigma_bullet, sigma_operator, sigma_machine, 
                                     sigma_bullet_operator, sigma_bullet_machine, 
                                     sigma_operator_machine, sigma_operator_bullet_machine, 
                                     sigma_error, 
                                     location_df){
  
  sim_data_skeleton <- data.frame(bullet = paste0("Bullet ", rep(1:n_bullets, each = n_operators*n_machines)), 
                                machine = paste0("Machine ", rep(1:n_machines, each = n_operators, times = n_bullets)), 
                                operator = paste0("Operator ", rep(1:n_operators, times = n_bullets*n_machines)))

  sim_data_skeleton$repetitions = rep(list(paste0("Round ", 1:n_reps)), nrow(sim_data_skeleton))
  sim_data_skeleton <- sim_data_skeleton %>% unnest(repetitions)

  sim_data_skeleton$location_df <- rep(list(location_df), nrow(sim_data_skeleton))
  sim_data_skeleton <- sim_data_skeleton %>% unnest(location_df)


  sim_data_skeleton %>% 
    nest(data = -bullet) %>%
    mutate(bullet_eff = rnorm(n_bullets, sd = sigma_bullet)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -operator) %>%
    mutate(operator_eff = rnorm(n_operators, sd = sigma_operator)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -machine) %>%
    mutate(machine_eff = rnorm(n_machines, sd = sigma_machine)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -c(bullet, operator)) %>%
    mutate(bullet_operator_eff = rnorm(n_bullets*n_operators, sd = sigma_bullet_operator)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -c(bullet, machine)) %>%
    mutate(bullet_machine_eff = rnorm(n_bullets*n_machines, sd = sigma_bullet_machine)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -c(operator, machine)) %>%
    mutate(operator_machine_eff = rnorm(n_operators*n_machines, sd = sigma_operator_machine)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -c(bullet, operator, machine)) %>%
    mutate(operator_bullet_machine_eff = rnorm(n_bullets*n_operators*n_machines, sd = sigma_operator_bullet_machine)) %>%
    unnest(cols = c(data)) %>%
    mutate(error_eff = rnorm(nrow(sim_data_skeleton), sd = sigma_error))


  sim_data <- sim_data %>% mutate(response = location_mus + bullet_eff + operator_eff + machine_eff + 
                      bullet_operator_eff + bullet_machine_eff + operator_machine_eff + 
                      operator_bullet_machine_eff + error_eff)


  sim_model_fit <- lmer(response~location_names + (1|bullet) + (1|operator) + (1|machine) + 
                        (1|bullet:operator) + (1|bullet:machine) + (1|operator:machine) + 
                        (1|bullet:operator:machine), 
                      data = sim_data, 
                      REML = F, 
                      control = lmerControl(optimizer = "Nelder_Mead"))

  sim_model_sigmas <- as.data.frame(VarCorr(sim_model_fit)) %>% select(grp, sdcor)
  
  singular <- isSingular(sim_model_fit)
  sim_model_sigmas$singular <- singular
  
  return(sim_model_sigmas)
}


```

```{r}
# n_bullets, n_operators, n_machines, n_reps, 
# sigma_bullet, sigma_operator, sigma_machine, 
# sigma_bullet_operator, sigma_bullet_machine, 
# sigma_operator_machine, sigma_operator_bullet_machine, 
# sigma_error, 
# location_df

n_bullets <- 3
n_operators <- 8
n_machines <- 2
n_reps <- 3:15
sigma_bullet = 0.05
sigma_operator = 0.001
sigma_machine = 0.02
sigma_bullet_operator = 0.0001
sigma_bullet_machine = 0.0001
sigma_operator_machine = 0.0001
sigma_operator_bullet_machine = 0.00001
sigma_error = 0.6
n_sims <- 1:1000

sim_wrapper_df <- expand.grid(n_bullets = n_bullets, n_operators = n_operators, n_machines = n_machines, 
                              n_reps = n_reps, 
                              sigma_bullet = sigma_bullet, sigma_operator = sigma_operator, 
                              sigma_machine = sigma_machine, 
                              sigma_bullet_operator = sigma_bullet_operator, 
                              sigma_bullet_machine = sigma_bullet_machine, 
                              sigma_operator_machine = sigma_operator_machine, 
                              sigma_operator_bullet_machine = sigma_operator_bullet_machine, 
                              sigma_error = sigma_error, 
                              n_sims = n_sims)

sim_df <- sim_wrapper_df %>% mutate(sim_results = pmap(list(n_bullets, n_operators, n_machines, n_reps, 
                                                  sigma_bullet, sigma_operator, 
                                                          sigma_machine, sigma_bullet_operator, 
                                                          sigma_bullet_machine, 
                                                          sigma_operator_machine,
                                                          sigma_operator_bullet_machine, 
                                                          sigma_error), 
                                             .f = function(n_bullets, n_operators, 
                                                          n_machines, n_reps, 
                                                          sigma_bullet, sigma_operator, 
                                                          sigma_machine, sigma_bullet_operator, 
                                                          sigma_bullet_machine, 
                                                          sigma_operator_machine,
                                                          sigma_operator_bullet_machine, 
                                                          sigma_error){
                                               simulate_sigma_estimates(n_bullets, n_operators, 
                                                          n_machines, n_reps, 
                                                          sigma_bullet, sigma_operator, 
                                                          sigma_machine, sigma_bullet_operator, 
                                                          sigma_bullet_machine, 
                                                          sigma_operator_machine,
                                                          sigma_operator_bullet_machine, 
                                                          sigma_error, location_df = location_df)
                                                          }))



sim_df %>% 
  unnest(sim_results) %>%
  ggplot() + 
  geom_histogram(aes(x = sdcor, fill = factor(n_reps)), position = "identity", alpha = 0.7) + 
  facet_grid(n_operators~grp, scales= "free_x") +
  theme_bw()

saveRDS(sim_df, "../data/simulation_results-orange_l1.rda")

```


```{r}
library(foreach)
library(doParallel)

#numCores <- 4 # on my own computer
numCores <- 8 # on the server
registerDoParallel(cores = numCores)

location_df <- readRDS("data/simulation_mus_orange_l1.rda")

list_out = foreach(m = 1:nrow(sim_wrapper_df)) %dopar% {
  
  data <- sim_wrapper_df[m,]
  n_bullets <- data$n_bullets
  n_operators <- data$n_operators
  n_machines <- data$n_machines
  n_reps <- data$n_reps
  sigma_bullet <- data$sigma_bullet
  sigma_operator <- data$sigma_operator
  sigma_machine <- data$sigma_machine
  sigma_bullet_operator <- data$sigma_bullet_operator
  sigma_bullet_machine <- data$sigma_bullet_machine
  sigma_operator_machine <- data$sigma_operator_machine
  sigma_operator_bullet_machine <- data$sigma_operator_bullet_machine
  sigma_error <- data$sigma_error
  
  sim_data_skeleton <- data.frame(bullet = paste0("Bullet ", rep(1:n_bullets, each = n_operators*n_machines)), 
                                machine = paste0("Machine ", rep(1:n_machines, each = n_operators, times = n_bullets)), 
                                operator = paste0("Operator ", rep(1:n_operators, times = n_bullets*n_machines)))

  sim_data_skeleton$repetitions = rep(list(paste0("Round ", 1:n_reps)), nrow(sim_data_skeleton))
  sim_data_skeleton <- sim_data_skeleton %>% unnest(repetitions)

  sim_data_skeleton$location_df <- rep(list(location_df), nrow(sim_data_skeleton))
  sim_data_skeleton <- sim_data_skeleton %>% unnest(location_df)


  sim_data_skeleton %>% 
    nest(data = -bullet) %>%
    mutate(bullet_eff = rnorm(n_bullets, sd = sigma_bullet)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -operator) %>%
    mutate(operator_eff = rnorm(n_operators, sd = sigma_operator)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -machine) %>%
    mutate(machine_eff = rnorm(n_machines, sd = sigma_machine)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -c(bullet, operator)) %>%
    mutate(bullet_operator_eff = rnorm(n_bullets*n_operators, sd = sigma_bullet_operator)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -c(bullet, machine)) %>%
    mutate(bullet_machine_eff = rnorm(n_bullets*n_machines, sd = sigma_bullet_machine)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -c(operator, machine)) %>%
    mutate(operator_machine_eff = rnorm(n_operators*n_machines, sd = sigma_operator_machine)) %>%
    unnest(cols = c(data)) %>%
    nest(data = -c(bullet, operator, machine)) %>%
    mutate(operator_bullet_machine_eff = rnorm(n_bullets*n_operators*n_machines, sd = sigma_operator_bullet_machine)) %>%
    unnest(cols = c(data)) %>%
    mutate(error_eff = rnorm(nrow(sim_data_skeleton), sd = sigma_error))


  sim_data <- sim_data %>% mutate(response = location_mus + bullet_eff + operator_eff + machine_eff + 
                      bullet_operator_eff + bullet_machine_eff + operator_machine_eff + 
                      operator_bullet_machine_eff + error_eff)


  sim_model_fit <- lmer(response~location_names + (1|bullet) + (1|operator) + (1|machine) + 
                        (1|bullet:operator) + (1|bullet:machine) + (1|operator:machine) + 
                        (1|bullet:operator:machine), 
                      data = sim_data, 
                      REML = F, 
                      control = lmerControl(optimizer = "Nelder_Mead"))

  sim_model_sigmas <- as.data.frame(VarCorr(sim_model_fit)) %>% select(grp, sdcor)
  
  singular <- isSingular(sim_model_fit)
  sim_model_sigmas$singular <- singular
  
  return(sim_model_sigmas)
                                           ## this is the matrix that is returned as list element m, in the list list_out.
}

sim_wrapper_df$sim_results <- list_out

saveRDS(sim_wrapper_df, "data/simulation/simulation_reps_orange.rda")


```




