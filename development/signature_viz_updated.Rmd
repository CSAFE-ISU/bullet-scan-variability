---
title: ""
output: html_document
---

```{r packages, echo = F, warning = F, message = F}
library(tidyverse)
library(gridExtra)
library(lme4)
library(bulletxtrctr)
bullet_palette3 <- hcl.colors(3, palette = "Zissou 1")
bullet_palette5 <- hcl.colors(5, palette = "Zissou 1")
bullet_palette6 <- hcl.colors(6, palette = "Zissou 1")
```

```{r}
blue_sigs <- readRDS("/Volumes/databuddy/Variability/data/Blue_all_sigs_updated.rda")

blue_sigs <- blue_sigs %>% select(source, operator, round, machine, barrel, bullet, land, scan_id, sigs)

blue_gt <- read_csv("../data/variability_scans/blue_gt_update.csv")
blue_sigs <- full_join(blue_sigs, blue_gt)

blue_ops <- read_csv("../data/variability_scans/operators_blind.csv")
blue_sigs <- left_join(blue_sigs, blue_ops)
#head(blue_sigs)
```

```{r}
bl_b1 <- blue_sigs %>% filter(unique_id == "BL B-1")
bl_b1 <- bl_b1 %>% mutate(sigs_aligned = purrr::map(sigs, .f = function(row){
  align <- sig_align(bl_b1$sigs[[1]]$sig, row$sig)
  lands <- align$lands
  lands <- lands[!is.na(lands$sig1),]
  lands$x_aligned <- 1:(dim(lands)[1])
  lands
}))


bl_b2 <- blue_sigs %>% filter(unique_id == "BL B-2")
bl_b2 <- bl_b2 %>% mutate(sigs_aligned = purrr::map(sigs, .f = function(row){
  align <- sig_align(bl_b2$sigs[[1]]$sig, row$sig)
  lands <- align$lands
  lands <- lands[!is.na(lands$sig1),]
  lands$x_aligned <- 1:(dim(lands)[1])
  lands
}))





bl_b3 <- blue_sigs %>% filter(unique_id == "BL B-3")
bl_b3 <- bl_b3 %>% mutate(sigs_aligned = purrr::map(sigs, .f = function(row){
  align <- sig_align(bl_b3$sigs[[1]]$sig, row$sig)
  lands <- align$lands
  lands <- lands[!is.na(lands$sig1),]
  lands$x_aligned <- 1:(dim(lands)[1])
  lands
}))



bl_b4 <- blue_sigs %>% filter(unique_id == "BL B-4")
bl_b4 <- bl_b4 %>% mutate(sigs_aligned = purrr::map(sigs, .f = function(row){
  align <- sig_align(bl_b4$sigs[[1]]$sig, row$sig)
  lands <- align$lands
  lands <- lands[!is.na(lands$sig1),]
  lands$x_aligned <- 1:(dim(lands)[1])
  lands
}))


bl_b5 <- blue_sigs %>% filter(unique_id == "BL B-5")
bl_b5 <- bl_b5 %>% mutate(sigs_aligned = purrr::map(sigs, .f = function(row){
  align <- sig_align(bl_b5$sigs[[1]]$sig, row$sig)
  lands <- align$lands
  lands <- lands[!is.na(lands$sig1),]
  lands$x_aligned <- 1:(dim(lands)[1])
  lands
}))

bl_b6 <- blue_sigs %>% filter(unique_id == "BL B-6")
bl_b6 <- bl_b6 %>% mutate(sigs_aligned = purrr::map(sigs, .f = function(row){
  ## grab one of connor's scans as base, this BL has tank rash/breakoff on 2 of 3 bullets
  align <- sig_align(bl_b6$sigs[[1]]$sig, row$sig) 
  lands <- align$lands
  lands <- lands[!is.na(lands$sig1),]
  lands$x_aligned <- 1:(dim(lands)[1])
  lands
}))

```

```{r}
blb1_long <- bl_b1 %>% unnest(sigs_aligned)
blb2_long <- bl_b2 %>% unnest(sigs_aligned)
blb3_long <- bl_b3 %>% unnest(sigs_aligned)
blb4_long <- bl_b4 %>% unnest(sigs_aligned)
blb5_long <- bl_b5 %>% unnest(sigs_aligned)
blb6_long <- bl_b6 %>% unnest(sigs_aligned)

blb1_long %>%
 #filter(operator != "Mya") %>%
 ggplot() +
 geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(bullet)), alpha = 0.7) +
 geom_line(aes(x = x_aligned, y = sig1)) +
 theme_bw() + 
 scale_color_manual(name = "Bullet", values = bullet_palette3)

blb2_long %>%
 #filter(operator != "Mya") %>%
 ggplot() +
 geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(bullet)), alpha = 0.7) +
 geom_line(aes(x = x_aligned, y = sig1)) +
 theme_bw() + 
 scale_color_manual(name = "Bullet", values = bullet_palette3)

blb3_long %>%
 #filter(operator != "Mya") %>%
 ggplot() +
 geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(bullet)), alpha = 0.7) +
 geom_line(aes(x = x_aligned, y = sig1)) +
 theme_bw() + 
 scale_color_manual(name = "Bullet", values = bullet_palette3)

blb4_long %>%
 #filter(operator != "Mya") %>%
 ggplot() +
 geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(bullet)), alpha = 0.7) +
 geom_line(aes(x = x_aligned, y = sig1)) +
 theme_bw() + 
 scale_color_manual(name = "Bullet", values = bullet_palette3)

blb5_long %>%
 #filter(operator != "Mya") %>%
 ggplot() +
 geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(bullet)), alpha = 0.7) +
 geom_line(aes(x = x_aligned, y = sig1)) +
 theme_bw() + 
 scale_color_manual(name = "Bullet", values = bullet_palette3)

blb6_long %>%
 #filter(operator != "Mya") %>%
 ggplot() +
 geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(bullet)), alpha = 0.7) +
 geom_line(aes(x = x_aligned, y = sig1)) +
 theme_bw() + 
 scale_color_manual(name = "Bullet", values = bullet_palette3)
```

```{r}
blb6_long %>%
 #filter(operator != "Mya") %>%
 ggplot() +
 geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(round)), alpha = 0.7) +
 #geom_line(aes(x = x_aligned, y = sig1)) +
 theme_bw() + 
 scale_color_manual(name = "Round", values = bullet_palette6) + 
  facet_grid(operator~bullet)

blb6_long %>%
  filter(operator == "Anyesha", round == "Round 1", bullet == "Bullet 2") %>%
  ggplot() +
  geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(machine)), alpha = 0.7) +
  #geom_line(aes(x = x_aligned, y = sig1)) +
   theme_bw() + 
  scale_color_manual(name = "Machine", values = bullet_palette3[c(1,3)])

blb6_long %>%
  filter(operator == "Mya", (round == "Round 3" | round == "Round 4"), bullet == "Bullet 1") %>%
  ggplot() +
  geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(machine), linetype = factor(round)), alpha = 0.7) +
  #geom_line(aes(x = x_aligned, y = sig1)) +
   theme_bw() + 
  scale_color_manual(name = "Machine", values = bullet_palette3[c(1,3)])


```

```{r}
blb2_long %>%
 #filter(operator != "Mya") %>%
 ggplot() +
 geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(round)), alpha = 0.7) +
 #geom_line(aes(x = x_aligned, y = sig1)) +
 theme_bw() + 
 scale_color_manual(name = "Round", values = bullet_palette6) + 
  facet_grid(operator~bullet)

blb2_long %>%
  filter(operator == "Mark", (round == "Round 4" | round == "Round 5"), bullet == "Bullet 2") %>%
  ggplot() +
  geom_line(aes(x = x_aligned, y = sig2, group = scan_id, color = factor(machine), linetype = factor(round)), alpha = 0.7) +
  #geom_line(aes(x = x_aligned, y = sig1)) +
   theme_bw() + 
  scale_color_manual(name = "Machine", values = bullet_palette3[c(1,3)])
```


